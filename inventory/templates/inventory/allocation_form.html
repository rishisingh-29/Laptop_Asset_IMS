{% extends "inventory/navigation_panel.html" %}
{% load widget_tweaks %}

{% block title %}Allocate/Return Asset{% endblock %}

{% block content %}
<main class="flex-1 p-10">
    <h1 class="text-2xl font-semibold mb-6">Hello Admin(IT) üëãüèº</h1>
    <div class="bg-white p-10 rounded-2xl shadow-lg max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h2 id="form-title" class="text-xl font-bold text-gray-900">Allocate Asset To User</h2>
            <label for="return-toggle" class="flex items-center cursor-pointer">
                <span class="mr-3 text-sm font-medium text-gray-900">Return</span>
                <div class="relative"><input type="checkbox" id="return-toggle" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div></div>
            </label>
        </div>

        <!-- =================================================================== -->
        <!-- ALLOCATE ASSET FORM                                                   -->
        <!-- =================================================================== -->
        <form id="allocate-form" method="POST" class="space-y-6">
            {% csrf_token %}<input type="hidden" name="form_type" value="allocate">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6">
                <!-- Loop through all fields and render them -->
                {% for field in allocation_form %}
                    {% if field.name == 'delivery_type' %}
                        <!-- Special handling for Radio buttons -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">{{ field.label }}</label>
                            <div id="allocation_delivery_options" class="flex items-center space-x-6 pt-2">
                                {% for radio in field %}
                                <label class="flex items-center cursor-pointer">
                                    {{ radio.tag }}
                                    <span class="ml-2 text-gray-700">{{ radio.choice_label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    {% elif field.name != 'allocation_docket_id' %}
                        <div>
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ field.label }}</label>
                            {% render_field field class+="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white" %}
                            {% for error in field.errors %}<p class="text-red-500 text-xs mt-1">{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- Docket ID field (initially hidden) -->
                <div id="allocation_docket_id_wrapper" class="hidden">
                    <label for="{{ allocation_form.allocation_docket_id.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Docket ID</label>
                    {% render_field allocation_form.allocation_docket_id class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter courier docket ID" %}
                </div>
            </div>
            <div class="flex justify-end items-center gap-4 mt-8 pt-6 border-t"><a href="{% url 'allocation_list' %}" class="px-8 py-3 border-2 border-purple-600 text-purple-600 rounded-lg hover:bg-purple-50 font-semibold">Cancel</a><button type="submit" class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold">Allocate</button></div>
        </form>

        <!-- =================================================================== -->
        <!-- RETURN ASSET FORM                                                     -->
        <!-- =================================================================== -->
        <form id="return-form" method="POST" class="hidden space-y-6">
            {% csrf_token %}<input type="hidden" name="form_type" value="return">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6">
                 {% for field in return_form %}
                    {% if field.name == 'delivery_type' %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">{{ field.label }}</label>
                            <div id="return_delivery_options" class="flex items-center space-x-6 pt-2">
                                {% for radio in field %}<label class="flex items-center cursor-pointer">{{ radio.tag }}<span class="ml-2 text-gray-700">{{ radio.choice_label }}</span></label>{% endfor %}
                            </div>
                        </div>
                    {% elif field.name != 'return_docket_id' %}
                        <div>
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ field.label }}</label>
                            {% render_field field class+="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white" %}
                            {% for error in field.errors %}<p class="text-red-500 text-xs mt-1">{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                 {% endfor %}

                 <!-- Docket ID field (initially hidden) -->
                <div id="return_docket_id_wrapper" class="hidden">
                    <label for="{{ return_form.return_docket_id.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Docket ID</label>
                    {% render_field return_form.return_docket_id class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter courier docket ID" %}
                </div>
            </div>
            <div class="flex justify-end items-center gap-4 mt-8 pt-6 border-t"><a href="{% url 'allocation_list' %}" class="px-8 py-3 border-2 border-purple-600 text-purple-600 rounded-lg hover:bg-purple-50 font-semibold">Cancel</a><button type="submit" class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold">Return</button></div>
        </form>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- General Toggle Logic ---
    const toggle = document.getElementById('return-toggle');
    const allocateForm = document.getElementById('allocate-form');
    const returnForm = document.getElementById('return-form');
    const formTitle = document.getElementById('form-title');

    function handleToggle() {
        if (toggle.checked) {
            allocateForm.style.display = 'none'; returnForm.style.display = 'block'; formTitle.textContent = 'Return Asset From User';
        } else {
            allocateForm.style.display = 'block'; returnForm.style.display = 'none'; formTitle.textContent = 'Allocate Asset To User';
        }
    }
    toggle.addEventListener('change', handleToggle);
    handleToggle();

    // --- Dynamic Fields for Allocation Form ---
    const assetSelect = document.getElementById('{{ allocation_form.asset.id_for_label }}');
    const makeInput = document.getElementById('{{ allocation_form.asset_make.id_for_label }}');
    const processorInput = document.getElementById('{{ allocation_form.asset_processor.id_for_label }}');

    assetSelect.addEventListener('change', function () {
        const assetId = this.value;
        if (assetId) {
            fetch(`{% url 'ajax_get_asset_details' %}?asset_id=${assetId}`)
                .then(response => response.json())
                .then(data => {
                    makeInput.value = data.brand || '';
                    processorInput.value = data.processor || '';
                });
        } else {
            makeInput.value = ''; processorInput.value = '';
        }
    });

    // --- Dynamic Dropdown for Return Form ---
    const returnEmailInput = document.getElementById('{{ return_form.employee_email.id_for_label }}');
    const returnAssetSelect = document.getElementById('{{ return_form.asset.id_for_label }}');

    returnEmailInput.addEventListener('blur', function () {
        const email = this.value;
        if (email) {
            fetch(`{% url 'ajax_get_employee_assets' %}?email=${email}`)
                .then(response => response.json())
                .then(data => {
                    returnAssetSelect.innerHTML = '<option value="">Select asset_id</option>';
                    data.assets.forEach(asset => {
                        const option = new Option(asset.text, asset.id);
                        returnAssetSelect.add(option);
                    });
                });
        }
    });

    // --- Show/Hide Docket ID Field Logic ---
    function setupDocketIdToggle(radioGroupName, docketWrapperId) {
        const deliveryOptions = document.querySelectorAll(`input[name="${radioGroupName}"]`);
        const docketWrapper = document.getElementById(docketWrapperId);
        
        deliveryOptions.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Courier') {
                    docketWrapper.classList.remove('hidden');
                } else {
                    docketWrapper.classList.add('hidden');
                }
            });
        });
    }

    setupDocketIdToggle('{{ allocation_form.delivery_type.name }}', 'allocation_docket_id_wrapper');
    setupDocketIdToggle('{{ return_form.delivery_type.name }}', 'return_docket_id_wrapper');
});
</script>
{% endblock %}
{% extends "inventory/_layouts/base.html" %}
{% load widget_tweaks %}

{% block title %}Manage Allocation{% endblock %}

{% block page_title %}Allocate or Return Asset{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
        
        <!-- Header with Modern Toggle Switch -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
            <div>
                <h2 id="form-title" class="text-xl font-bold text-gray-900 dark:text-white">Allocate Asset To User</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Use the switch to toggle between assigning and returning an asset.</p>
            </div>
            <div class="flex items-center space-x-3 self-start sm:self-center">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Assign</span>
                <label for="return-toggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="return-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 dark:bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                </label>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Return</span>
            </div>
        </div>

        <!-- =================================================================== -->
        <!-- ALLOCATE ASSET FORM                                                 -->
        <!-- =================================================================== -->
        <form id="allocate-form" method="POST" class="space-y-6">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="allocate">
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for field in allocation_form %}
                    {% if field.name == 'delivery_type' %}
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ field.label }}</label>
                            <div id="allocation_delivery_options" class="flex items-center space-x-6 pt-2">
                                {% for radio in field %}
                                <label class="flex items-center cursor-pointer">
                                    <!-- =================================================================== -->
                                    <!-- THE FIX: Manually build the input tag to apply classes correctly.   -->
                                    <!-- =================================================================== -->
                                    <input type="radio" name="{{ field.html_name }}" value="{{ radio.choice_value }}" id="{{ radio.id_for_label }}" 
                                           class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-900 dark:focus:ring-purple-600 dark:ring-offset-gray-800" 
                                           {% if field.value|stringformat:"s" == radio.choice_value %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">{{ radio.choice_label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    {% elif field.name != 'allocation_docket_id' %}
                        <div class="{% if forloop.counter > 4 %}lg:col-span-1{% else %}lg:col-span-1{% endif %}">
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">{{ field.label }}</label>
                            {% render_field field class+="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm" %}
                            {% for error in field.errors %}<p class="mt-1 text-xs text-red-500 dark:text-red-400">{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}

                <div id="allocation_docket_id_wrapper" class="hidden md:col-span-2 lg:col-span-3">
                    <label for="{{ allocation_form.allocation_docket_id.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">{{ allocation_form.allocation_docket_id.label }}</label>
                    {% render_field allocation_form.allocation_docket_id class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-purple-500 focus:border-purple-500 text-sm" placeholder="Enter courier docket ID" %}
                </div>
            </div>
            
            <div class="flex justify-end items-center gap-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="{% url 'inventory:allocation_list' %}" class="px-5 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition">Cancel</a>
                <button type="submit" name="form_type" value="assign" class="px-5 py-2.5 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 dark:focus:ring-offset-gray-800 transition">Allocate</button>
            </div>
        </form>

        <!-- =================================================================== -->
        <!-- RETURN ASSET FORM                                                   -->
        <!-- =================================================================== -->
        <form id="return-form" method="POST" class="hidden space-y-6">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="return">
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 {% for field in return_form %}
                    {% if field.name == 'delivery_type' %}
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ field.label }}</label>
                            <div id="return_delivery_options" class="flex items-center space-x-6 pt-2">
                                {% for radio in field %}
                                <label class="flex items-center cursor-pointer">
                                    <!-- =================================================================== -->
                                    <!-- THE FIX: Manually build the input tag to apply classes correctly.   -->
                                    <!-- =================================================================== -->
                                    <input type="radio" name="{{ field.html_name }}" value="{{ radio.choice_value }}" id="{{ radio.id_for_label }}" 
                                           class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-900 dark:focus:ring-purple-600 dark:ring-offset-gray-800" 
                                           {% if field.value|stringformat:"s" == radio.choice_value %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">{{ radio.choice_label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    {% elif field.name != 'return_docket_id' %}
                        <div class="{% if field.name == 'remarks' %}md:col-span-2 lg:col-span-3{% else %}lg:col-span-1{% endif %}">
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">{{ field.label }}</label>
                            {% if field.name == 'remarks' %}
                                {% render_field field class+="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm" rows="3" %}
                            {% else %}
                                {% render_field field class+="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm" %}
                            {% endif %}
                            {% for error in field.errors %}<p class="mt-1 text-xs text-red-500 dark:text-red-400">{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                 {% endfor %}

                <div id="return_docket_id_wrapper" class="hidden md:col-span-2 lg:col-span-3">
                    <label for="{{ return_form.return_docket_id.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">{{ return_form.return_docket_id.label }}</label>
                    {% render_field return_form.return_docket_id class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-purple-500 focus:border-purple-500 text-sm" placeholder="Enter courier docket ID" %}
                </div>
            </div>

            <div class="flex justify-end items-center gap-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="{% url 'inventory:allocation_list' %}" class="px-5 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition">Cancel</a>
                <button type="submit" name="form_type" value="return" class="px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800 transition">Process Return</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- General Toggle Logic ---
    const toggle = document.getElementById('return-toggle');
    const allocateForm = document.getElementById('allocate-form');
    const returnForm = document.getElementById('return-form');
    const formTitle = document.getElementById('form-title');

    function handleToggle() {
        if (toggle.checked) {
            allocateForm.style.display = 'none';
            returnForm.style.display = 'block';
            formTitle.textContent = 'Return Asset From User';
        } else {
            allocateForm.style.display = 'block';
            returnForm.style.display = 'none';
            formTitle.textContent = 'Allocate Asset To User';
        }
    }
    toggle.addEventListener('change', handleToggle);
    handleToggle(); // Set initial state on page load

    // --- Dynamic Fields for Allocation Form ---
    const assetSelect = document.getElementById('{{ allocation_form.asset.id_for_label }}');
    const makeInput = document.getElementById('{{ allocation_form.asset_make.id_for_label }}');
    const processorInput = document.getElementById('{{ allocation_form.asset_processor.id_for_label }}');

    if(assetSelect) {
        assetSelect.addEventListener('change', function () {
            const assetId = this.value;
            if (assetId) {
                fetch(`/api/asset-details/${assetId}/`)
                    .then(response => {
                        if (!response.ok) { throw new Error('Network response was not ok'); }
                        return response.json();
                    })
                    .then(data => {
                        if (makeInput) makeInput.value = data.brand || '';
                        if (processorInput) processorInput.value = data.processor || '';
                    })
                    .catch(error => console.error("Error fetching asset details:", error));
            } else {
                if (makeInput) makeInput.value = '';
                if (processorInput) processorInput.value = '';
            }
        });
    }

    // --- Dynamic Dropdown for Return Form ---
    const returnEmailInput = document.getElementById('{{ return_form.employee_email.id_for_label }}');
    const returnAssetSelect = document.getElementById('{{ return_form.asset.id_for_label }}');

    if (returnEmailInput) {
        returnEmailInput.addEventListener('blur', function () {
            const email = this.value;
            if (email) {
                fetch(`/api/employee-assets/?email=${encodeURIComponent(email)}`)
                    .then(response => {
                        if (!response.ok) { throw new Error('Network response was not ok'); }
                        return response.json();
                    })
                    .then(data => {
                        if (returnAssetSelect) {
                            returnAssetSelect.innerHTML = '<option value="">Select an asset</option>';
                            if (data.assets && data.assets.length > 0) {
                                data.assets.forEach(asset => {
                                    const option = new Option(`${asset.text} (${asset.serial})`, asset.id);
                                    returnAssetSelect.add(option);
                                });
                            } else {
                                const option = new Option('No assets found for this employee', '');
                                option.disabled = true;
                                returnAssetSelect.add(option);
                            }
                        }
                    })
                    .catch(error => console.error("Error fetching employee assets:", error));
            }
        });
    }

    // --- Show/Hide Docket ID Field Logic ---
    function setupDocketIdToggle(formId, radioGroupName, docketWrapperId) {
        const form = document.getElementById(formId);
        if (!form) return;
        
        const deliveryOptions = form.querySelectorAll(`input[name="${radioGroupName}"]`);
        const docketWrapper = document.getElementById(docketWrapperId);
        
        if (docketWrapper && deliveryOptions.length > 0) {
            const toggleDocketVisibility = () => {
                const selectedOption = form.querySelector(`input[name="${radioGroupName}"]:checked`);
                if (selectedOption && selectedOption.value === 'Courier') {
                    docketWrapper.classList.remove('hidden');
                } else {
                    docketWrapper.classList.add('hidden');
                }
            };
            
            deliveryOptions.forEach(radio => {
                radio.addEventListener('change', toggleDocketVisibility);
            });

            // Set initial state on page load
            toggleDocketVisibility();
        }
    }

    setupDocketIdToggle('allocate-form', '{{ allocation_form.delivery_type.name }}', 'allocation_docket_id_wrapper');
    setupDocketIdToggle('return-form', '{{ return_form.delivery_type.name }}', 'return_docket_id_wrapper');
});
</script>
{% endblock %}
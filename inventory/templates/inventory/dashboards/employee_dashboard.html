{% extends "inventory/_layouts/base.html" %}

{% block title %}My Dashboard{% endblock %}

{% block page_title %}My Dashboard{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Welcome Header -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Hello, {{ request.user.employee.full_name|default:request.user.username }}!</h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">
            This is your personal dashboard. Here you can find a list of all IT assets that are currently assigned to you.
        </p>
    </div>

    <!-- Assigned Assets List -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white">My Assigned Assets</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">A list of devices currently in your possession.</p>
        </div>

        <!-- Responsive Table Container -->
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-600 dark:text-gray-400">
                <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700/50">
                    <tr>
                        <th scope="col" class="px-6 py-3">Asset Model</th>
                        <th scope="col" class="px-6 py-3">Serial Number</th>
                        <th scope="col" class="px-6 py-3">Assigned On</th>
                        <th scope="col" class="px-6 py-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for allocation in assigned_allocations %}
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap">
                            <i class="fas fa-laptop text-purple-500 mr-2"></i>
                            {{ allocation.asset.brand }} {{ allocation.asset.model }}
                        </td>
                        <td class="px-6 py-4 font-mono">{{ allocation.asset.serial_number }}</td>
                        <td class="px-6 py-4">{{ allocation.assigned_date|date:"F d, Y" }}</td>
                        <td class="px-6 py-4 text-center">
                            <!-- This button will trigger the history modal. A new view/URL will be needed to fetch this data. -->
                            <button 
                                type="button" 
                                class="view-history-btn font-medium text-purple-600 dark:text-purple-400 hover:underline"
                                data-asset-id="{{ allocation.asset.asset_id }}"
                                data-asset-name="{{ allocation.asset.brand }} {{ allocation.asset.model }} ({{ allocation.asset.serial_number }})">
                                View History
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Validation: Message for employees with no assets -->
            {% if not assigned_allocations %}
                <div class="text-center py-12 px-6">
                    <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/30">
                        <i class="fas fa-info-circle text-3xl text-blue-500 dark:text-blue-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">No Assets Found</h3>
                    <p class="mt-2 text-gray-500 dark:text-gray-400">You do not have any assets currently assigned to you.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Asset History Modal (Initially Hidden) -->
<div id="history-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 hidden">
    <div id="history-modal-content" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all opacity-0 -translate-y-10">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-5 border-b border-gray-200 dark:border-gray-700">
            <div>
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Asset Transaction History</h3>
                <p id="modal-asset-name" class="text-sm text-gray-500 dark:text-gray-400"></p>
            </div>
            <button type="button" id="close-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 dark:hover:bg-gray-600 hover:text-gray-900 dark:hover:text-white rounded-lg text-sm p-2">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <!-- Modal Body -->
        <div id="modal-body-content" class="p-6 space-y-4 max-h-96 overflow-y-auto">
            <!-- History will be loaded here by JavaScript -->
            <div id="modal-spinner" class="text-center py-8"><i class="fas fa-spinner fa-spin text-purple-500 text-3xl"></i></div>
            <ul id="history-list" class="hidden"></ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('history-modal');
    const modalContent = document.getElementById('history-modal-content');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const modalAssetName = document.getElementById('modal-asset-name');
    const historyList = document.getElementById('history-list');
    const modalSpinner = document.getElementById('modal-spinner');

    function showModal() {
        modal.classList.remove('hidden');
        setTimeout(() => { 
            modalContent.classList.remove('opacity-0', '-translate-y-10');
        }, 10);
    }

    function hideModal() {
        modalContent.classList.add('opacity-0', '-translate-y-10');
        setTimeout(() => {
            modal.classList.add('hidden');
            // Reset state for next time
            historyList.innerHTML = '';
            historyList.classList.add('hidden');
            modalSpinner.classList.remove('hidden');
        }, 300);
    }

    closeModalBtn.addEventListener('click', hideModal);
    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            hideModal();
        }
    });

    document.querySelectorAll('.view-history-btn').forEach(button => {
        button.addEventListener('click', async (event) => {
            const assetId = event.target.dataset.assetId;
            const assetName = event.target.dataset.assetName;
            
            modalAssetName.textContent = assetName;
            showModal();

            try {
                // IMPORTANT: You will need to create a URL named 'get_asset_history' that points to a view
                // which takes an asset_id and returns a JSON response of its history.
                const response = await fetch(`/api/asset-history/${assetId}/`);
                if (!response.ok) throw new Error('Network response was not ok.');
                
                const data = await response.json();

                historyList.innerHTML = ''; // Clear previous results
                if (data.history && data.history.length > 0) {
                    data.history.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'p-4 border-b dark:border-gray-700';
                        li.innerHTML = `
                            <p class="font-semibold text-gray-800 dark:text-white">${item.employee_name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Assigned: ${new Date(item.assigned_date).toLocaleDateString()}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Returned: ${item.returned_date ? new Date(item.returned_date).toLocaleDateString() : 'Currently Assigned'}</p>
                        `;
                        historyList.appendChild(li);
                    });
                } else {
                    historyList.innerHTML = '<li class="p-4 text-center text-gray-500 dark:text-gray-400">No transaction history found for this asset.</li>';
                }

            } catch (error) {
                console.error('Failed to fetch asset history:', error);
                historyList.innerHTML = '<li class="p-4 text-center text-red-500 dark:text-red-400">Could not load history. Please try again later.</li>';
            } finally {
                modalSpinner.classList.add('hidden');
                historyList.classList.remove('hidden');
            }
        });
    });
});
</script>
{% endblock %}